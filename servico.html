<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Serviço | Biolacqua</title>
  <meta name="description" content="Detalhes dos serviços Biolacqua.">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <link rel="stylesheet" href="assets/css/styles.css">
  <style>
    .sticky-safe { position: sticky; top: 96px }
    .toc a.text-biolacqua { font-weight: 700 }
    .prose ul { list-style: disc; margin-left: 1.25rem }
  </style>
</head>
<body class="bg-white text-slate-800">
  <!-- Navbar -->
  <nav class="bg-white/90 backdrop-blur shadow-sm fixed w-full z-10">
    <div class="container mx-auto px-6 py-3">
      <div class="flex justify-between items-center">
        <img src="assets/images/logo-biolacqua.png" alt="Biolacqua Logo" class="h-12">
        <div class="hidden md:flex space-x-8 text-sm">
          <a href="/" class="text-slate-600 hover:text-biolacqua">Início</a>
          <a href="/#about" class="text-slate-600 hover:text-biolacqua">Sobre</a>
          <a href="/#services" class="text-biolacqua font-medium">Serviços</a>
          <a href="/#products" class="text-slate-600 hover:text-biolacqua">Produtos</a>
          <a href="/#contact" class="text-slate-600 hover:text-biolacqua">Contato</a>
        </div>
        <button class="md:hidden" id="menu-toggle"><i data-feather="menu"></i></button>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <header class="pt-20 bg-gradient-to-b from-slate-50 to-white">
    <div class="container mx-auto px-6 py-12">
      <nav class="text-sm text-slate-500 mb-3">
        <a href="/" class="hover:text-biolacqua">Início</a>
        <span class="mx-2">/</span>
        <a href="/#services" class="hover:text-biolacqua">Serviços</a>
        <span class="mx-2">/</span>
        <span id="bread-service">Serviço</span>
      </nav>
      <h1 id="service-title" class="text-3xl md:text-4xl font-bold text-biolacqua">Serviço</h1>
      <p id="service-subtitle" class="mt-2 text-slate-600 max-w-3xl">Detalhes do serviço.</p>
    </div>
  </header>

  <!-- Conteúdo -->
  <main class="py-12">
    <div class="container mx-auto px-6 flex flex-col lg:flex-row gap-10">
      <!-- Sidebar -->
      <aside class="lg:w-1/4">
        <div class="sticky-safe">
          <div class="bg-white border rounded-xl shadow-sm p-5">
            <h3 class="text-xs font-semibold text-slate-500 uppercase mb-3">Navegação</h3>
            <ul class="space-y-2 toc text-slate-600">
              <li><a href="#visao-geral" class="hover:text-biolacqua">Visão geral</a></li>
              <li><a href="#metodologia" class="hover:text-biolacqua">Metodologia</a></li>
            </ul>
          </div>
          <div class="bg-white border rounded-xl shadow-sm p-5 mt-6">
            <h3 class="text-xs font-semibold text-slate-500 uppercase mb-3">Produtos e Serviços</h3>
            <ul class="space-y-2 text-sm" id="sidebar-services"></ul>
          </div>
        </div>
      </aside>

      <!-- Principal -->
      <article class="lg:w-3/4">
        <div class="bg-white rounded-2xl shadow-md p-6 md:p-8">
          <div id="service-cover" class="w-full mb-6 overflow-hidden rounded-xl bg-slate-100"></div>

          <section id="visao-geral" class="prose max-w-none mb-8">
            <h2 class="text-2xl font-bold">Visão geral</h2>
            <p id="service-intro"></p>
            <p id="service-intro-2"></p>
          </section>

          <section id="metodologia" class="prose max-w-none">
            <h2 class="text-2xl font-bold">Metodologia</h2>
            <p id="service-method"></p>
            <p id="service-refs" class="text-sm text-slate-500">
              Consulte nosso escopo acreditado:
              <a id="service-scope-link" href="#" target="_blank" rel="noopener" class="text-biolacqua underline">Ver escopo</a>
            </p>
            <p id="service-legal"></p>
          </section>
        </div>

        <!-- Prev/Next (mantido) -->
        <div class="mt-8 flex justify-between text-sm">
          <a class="text-slate-600 hover:text-biolacqua" id="prev-service"></a>
          <a class="text-slate-600 hover:text-biolacqua" id="next-service"></a>
        </div>
      </article>
    </div>
  </main>

  <a href="https://wa.me/551126516733" class="whatsapp-button" target="_blank">
    <i class="fab fa-whatsapp"></i>
  </a>

<script>
  const SERVICES_JSON_PATH = "./assets/data/services.json?v=" + Date.now();
  const $  = (s) => document.querySelector(s);

  function show(el){
    if(el){
      el.classList.remove('hidden');
      el.style.removeProperty('display');
    }
  }

  function hide(el){
    if(el){
      el.classList.add('hidden');
      el.style.display = 'none';
    }
  }

  function setTextOrHide(selector, value){
    const el = $(selector);
    if (!el) return false;
    const has = value !== undefined && value !== null && String(value).trim() !== "";
    if (!has){
      hide(el);
      return false;
    }
    el.textContent = value;
    show(el);
    return true;
  }

  async function main(){
    const slug = new URLSearchParams(location.search).get("s") || "analises-de-aguas";

    // Carrega JSON
    let payload;
    try{
      const res = await fetch(SERVICES_JSON_PATH, { cache: "no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      payload = await res.json();
    }catch(err){
      setTextOrHide("#service-title", "Erro ao carregar dados");
      setTextOrHide("#service-subtitle", "Verifique assets/data/services.json.");
      console.error(err);
      return;
    }

    const items = payload.items || {};
    const data  = items[slug];

    if (!data){
      setTextOrHide("#service-title", "Serviço não encontrado");
      setTextOrHide("#service-subtitle", "Verifique o endereço ou escolha outro serviço.");
      const sidebar = $("#sidebar-services");
      if (sidebar){
        (payload.order || Object.keys(items)).forEach(s => {
          const t = items[s]?.title || s;
          sidebar.insertAdjacentHTML("beforeend", `<li><a href="servico.html?s=${s}" class="hover:text-biolacqua">${t}</a></li>`);
        });
      }
      return;
    }

    // Cabeçalho
    setTextOrHide("#service-title", data.title);
    setTextOrHide("#bread-service",  data.title);
    setTextOrHide("#service-subtitle", data.subtitle);

    // Capa
    const cover = $("#service-cover");
    if (cover && data.cover && String(data.cover).trim() !== ""){
      cover.innerHTML = `<img src="${data.cover}" alt="${data.title}" class="w-full h-56 md:h-80 object-cover">`;
      show(cover);
    } else {
      hide(cover);
    }

    // Visão geral
    setTextOrHide("#service-intro",   data.intro);
    setTextOrHide("#service-intro-2", data.intro2);

    // --- Metodologia (só mostra se tiver conteúdo) ---
    const hasMethod = setTextOrHide("#service-method", data.method);

    let hasScope = false;
    const refs = $("#service-refs");
    const scopeLinkEl = $("#service-scope-link");
    if (data.scopeLink && String(data.scopeLink).trim() !== "") {
      if (scopeLinkEl) scopeLinkEl.href = data.scopeLink;
      show(refs);
      hasScope = true;
    } else {
      hide(refs);
    }

    const hasLegal = setTextOrHide("#service-legal", data.legal);

    const metodologiaSection = $("#metodologia");
    const hasMetodologiaContent = hasMethod || hasScope || hasLegal;

    if (!hasMetodologiaContent && metodologiaSection) {
      // Esconde a seção inteira
      hide(metodologiaSection);
      // Remove/oculta link do TOC
      const tocLink = document.querySelector('.toc a[href="#metodologia"]');
      if (tocLink && tocLink.parentElement) {
        hide(tocLink.parentElement);
      }
    }

    // Sidebar dinâmica (lista de serviços)
    const order   = payload.order || Object.keys(items);
    const sidebar = $("#sidebar-services");
    if (sidebar){
      sidebar.innerHTML = order.map(s => {
        const it = items[s];
        const active = s === slug ? "text-biolacqua font-semibold" : "hover:text-biolacqua";
        return `<li><a href="servico.html?s=${s}" class="${active}">${it?.title || s}</a></li>`;
      }).join("");
    }

    // Prev/Next
    const idx = order.indexOf(slug);
    const prevSlug = order[(idx - 1 + order.length) % order.length];
    const nextSlug = order[(idx + 1) % order.length];
    const prevA = $("#prev-service"), nextA = $("#next-service");
    if (prevA){
      prevA.href = `servico.html?s=${prevSlug}`;
      prevA.textContent = "← " + (items[prevSlug]?.title || prevSlug);
    }
    if (nextA){
      nextA.href = `servico.html?s=${nextSlug}`;
      nextA.textContent = (items[nextSlug]?.title || nextSlug) + " →";
    }

    if (window.feather) feather.replace();
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", main);
  } else {
    main();
  }

  // TOC highlight (Visão geral + Metodologia, se existir)
  document.addEventListener('DOMContentLoaded', () => {
    const links = [...document.querySelectorAll('.toc a')];
    const sections = links
      .map(a => document.querySelector(a.getAttribute('href')))
      .filter(Boolean);

    const setActive = (id) => {
      links.forEach(a =>
        a.classList.toggle('text-biolacqua', a.getAttribute('href') === '#' + id)
      );
    };

    const obs = new IntersectionObserver((entries) => {
      const visible = entries
        .filter(e => e.isIntersecting)
        .sort((a,b) => b.intersectionRatio - a.intersectionRatio)[0];
      if (visible) setActive(visible.target.id);
    }, { rootMargin: "-20% 0px -60% 0px", threshold: [0, 0.25, 0.5, 0.75, 1] });

    sections.forEach(s => obs.observe(s));
  });
</script>
</body>
</html>
